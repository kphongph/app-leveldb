<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="./app-leveldb-common-behavior.html">

<script src="../dexie/dist/dexie.js"></script>
<script src="../dexie/addons/Dexie.Observable/dist/dexie-observable.min.js">
</script>
<script src="../dexie/addons/Dexie.Syncable/dist/dexie-syncable.min.js">
</script>

<script>
(function() {
  'use strict';

  Dexie.Syncable.registerSyncProtocol("leveldb-log", {
    sync:function(context, url, options, baseRevision, 
      syncedRevision, changes, partial, 
      applyRemoteChanges, onChangesAccepted, 
      onSuccess, onError) {

      if(!baseRevision && options.filter) {
        var filter = options.filter;
        var request = document.createElement('iron-request');
        var app = options.app;
        baseRevision = (new Date()).getTime()-(24*60*60*1000);
        request.send({
          url:filter.url,
          method:"POST",
          headers:{
            'Authorization':'JWT '+options.app.jwtToken,
            'Content-Type':'application/json'
          },
            body:JSON.stringify(filter.query),
            handleAs:"json",
          }).then(function() {
            var _remoteChanges = [];
            var count = 0;
            request.response.forEach(function(item) {
              _remoteChanges.push({
                'type':1,
                'table':'documents',
                'obj':{'key':item.value.key,'value':item.value.doc}
              });
            });
            applyRemoteChanges(_remoteChanges,baseRevision,false,false);
          }).catch(function(err) {
          });
      } else {
        /*
        var request = document.createElement('iron-request');
        request.send({
          url:url+'?start='+baseRevision,
          method:"GET",
          body:{'start':baseRevision},
          headers:{
            'Authorization':'JWT '+options.jwtToken
          },
          handleAs:"json"
        }).then(function() {
          console.log(request.response);
        });
        */
      }
    }
  });

  Polymer.AppLeveldbDatabaseBehaviorImpl = {
    properties: {
      filterUrl:{
        type:String
      },
      filterStart: {
        type:Array,
        value:function() {
          return [];
        }
      },
      filterEnd: {
        type:Array,
        value:function() {
          return [];
        }
      },
      name:{
        type:String
      },
      db:{
        type:Object,
        computed: '__computeDb(app,name,filterUrl,filterStart,filterEnd)',
        notify:true
      }
    },
    save:function(data) {
     var self = this;
     return new Promise(function(fulfill,reject) {
       self.db.documents.get(data.value).then(function(obj) {
         if(!obj) {
           reject({key:data.value});
         } else {
           fulfill(obj);
         }
       });
     });
    },
    put:function(obj) {
     this.db.tables.forEach(function(table) {
       table.put(obj);
     });
    },
    __computeDb:function(app,name,filterUrl,filterStart,filterEnd) {
      if(!name) {
        return null;
      }
      var _db = new Dexie(name);
      var schema = {};
      schema['documents'] = 'key';
      
      var url = app.url+'/log/'+app.dbName;
      var filter = {};
      var query = {limit:-1,include_doc:true};

      if(filterStart.length != 0) {
        query['start']=filterEnd;
      }

      if(filterEnd.length != 0) {
        query['end']=filterEnd;
      }
      
      if(filterUrl.length != 0) {
         filter['url']=filterUrl;
         filter['query']=query;
      }

      var opt = {
        'app':app,
        'jwtToken':app.jwtToken,
        'filter': filter
      };
      
      console.log(app,name,opt);
      _db.version(1).stores(schema);
      _db.syncable.connect('leveldb-log',url,opt);
      _db.documents.toArray();
      return _db;
    }
  };
  Polymer.AppLeveldbDatabaseBehavior = [
    Polymer.AppLeveldbCommonBehavior,
    Polymer.AppLeveldbDatabaseBehaviorImpl
  ];
})();   
  
</script>
