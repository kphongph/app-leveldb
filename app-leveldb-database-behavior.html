<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<script src="../dexie/dist/dexie.js"></script>

<script>
(function() {
  'use strict';
  Polymer.AppLevelDBDatabaseBehavior = {
    properties: {
      data:{
        type:Array,
        notify:true,
        value:function() {
          return [];
        }
      },
      dbLocation: {
        type:String
      },
      dbName: {
        type:String
      },
      viewName: {
        type:String
      },
      apiKey: {
        type:String
      },
      waitingList: { 
        type:Array,
        readOnly:true,
        notify:true,
        value:function() {
          return [];
        }
      },
      db:{
        type:Object,
        computed: '__computeDb(dbName,viewName)',
        notify:true,
      }
    },
    observers:[
      '_waitingChanged(waitingList.splices)'
    ],
    ready:function() {
      var _this = this;
      this.db.hook('creating',function(key,obj,trans) {
        if(obj.index) {
          _this.push('waitingList',obj);
        }
      });
    },
    put:function(obj) {
      obj['dirty']=true;
      this.db.put(obj);
    },
    _waitingChanged:function() {
      var list = this.waitingList;
      if(list.length > 0) {
        var obj = list[0];
        if(obj.index) {
          console.log('indexing');
        }
        console.log(list);
      }
    },
    __pull:function(key,cb) {
      var url = this.dbLocation+"/api/dbs/"+this.dbName+"/"+key;
      url = url+'?apikey='+this.apiKey;
      var _this = this; 
      var request = document.createElement('iron-request');
      request.send({
        url:url,
        method:"GET", 
        handleAs:"json",
      }).then(function() {
        cb({key:key,value:request.response});
      });     
    },
    getData:function(key,cb) {
      var _this = this;
      this.db.get(key,function(obj) {
        if(obj) {
          cb(obj); 
        } else {
          cb(null);
        }
      });
    },
    saveIndex:function(index) {
      var _this = this;
      this.db.get(index.value).then(function(obj) {
        if(!obj) {
          _this.db.put({key:index.value,index:true});
        } 
      });
    },
    __computeDb:function(dbName,viewName) {

      if(!dbName) {
        return null;
      }

      if(!viewName) {
        return null;
      }
      var _db = new Dexie(dbName);
      var schema = {};
      schema[viewName] = 'key';
      _db.version(1).stores(schema);
           
      return _db[viewName];
    }
  };
})();   
</script>
