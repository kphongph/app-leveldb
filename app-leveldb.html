<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="./app-leveldb-database-behavior.html">

<!--
`app-leveldb`

@demo demo/index.html 
-->

<dom-module id="app-leveldb">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Hello </h2>
    <template is="dom-if" if="{{syncing}}">
      Syning..  [[waiting]]
    </template>

    <iron-ajax id="syncAjax"
      method="POST"
      url$="{{dbLocation}}/api/query/{{dbName}}/{{viewName}}"
      params$='{"apikey":"{{apiKey}}"}'
      body="{{query}}"
      content-type="application/json"
      on-response="_handleSyncAjax"
      handle-as="json">
    </iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'app-leveldb',

      behaviors: [
        Polymer.AppLevelDBDatabaseBehavior
      ],

      properties: {
        query:Object,
        waiting: {
          type:Number,
          computed:'_waitingCount(waitingList.length)'
        }
      },
      observers:[
        '_listDb(db)'
      ],
      _waitingCount:function(waitingList) {
        console.log(waitingList);
        return waitingList;
      },
      _listDb:function(db) {
        this.$.syncAjax.generateRequest();
      },
      _handleSyncAjax:function(e) { 
        console.log(e.detail.response);
        e.detail.response.forEach(function(item) {
          this.saveIndex(item);
        }.bind(this));
      }
      
    });
  </script>
</dom-module>
