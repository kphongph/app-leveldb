<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="./app-leveldb-database-behavior.html">

<!--
`app-leveldb`

@demo demo/index.html 
-->

<dom-module id="app-leveldb">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Hello [[prop1]]</h2>

    <iron-request id="getAjax"></iron-request>  

    <iron-ajax id="syncAjax"
      method="POST"
      url$="{{dbLocation}}/api/query/{{dbName}}/{{viewName}}"
      params$='{"apikey":"{{apiKey}}"}'
      body="{{query}}"
      content-type="application/json"
      on-response="_handleSyncAjax"
      handle-as="json">
    </iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'app-leveldb',

      behaviors: [
        Polymer.AppLevelDBDatabaseBehavior
      ],

      properties: {
        prop1: {
          type: String,
          value: 'app-leveldb',
        },
        query:Object,
        dbLocation:String,
        apiKey:String
      },
      observers:[
        '_listDb(db)'
      ],
      _get:function(key,cb) {
        var url = this.dbLocation+"/api/dbs/"+this.dbName+"/"+key;
        url = url+'?apikey='+this.apiKey;
        var _this = this;
        this.$.getAjax.send({
          url:url,
          method:"GET", 
          handleAs:"json",
        }).then(function() {
          cb({key:key,value:_this.$.getAjax.response});
        });
      },
      _listDb:function(db) {
        this.$.syncAjax.generateRequest();
      },
      _handleSyncAjax:function(e) { 
        console.log(e.detail.response);
        var _this = this;
        e.detail.response.forEach(function(item) {
          _this.saveIndex(item);
        });
        
        this.get('65d9fce0e52e11e6a39d8d32416b74be',function(test) {
          console.log(test);
          if(test) {
            _this.put(test);
          }
        });
      }
      
    });
  </script>
</dom-module>
